(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-main-optable-optable"],{"04c2":function(t,e,i){"use strict";i.r(e);var a=i("5ce1"),n=i.n(a);for(var o in a)["default"].indexOf(o)<0&&function(t){i.d(e,t,(function(){return a[t]}))}(o);e["default"]=n.a},"14c6":function(t,e,i){"use strict";var a=i("de2d"),n=i.n(a);n.a},"4e14":function(t,e,i){"use strict";e["a"]=function(t){(t.options.wxs||(t.options.wxs={}))["m"]=function(t){return t.exports.s=function(t){return t.split(" ")[1]},t.exports}({exports:{}})}},"579c":function(t,e,i){var a=i("24fb");e=a(!1),e.push([t.i,".FORMlineright[data-v-14cfa353]{max-width:%?525?%;overflow:scroll}.FORMtextline[data-v-14cfa353],\r\n.FORMheadline[data-v-14cfa353]{font-weight:800}.FORMtextline[data-v-14cfa353]{font-size:%?35?%}uni-view[data-v-14cfa353],\r\nuni-text[data-v-14cfa353]{-webkit-user-select:text;user-select:text}.container[data-v-14cfa353]{display:flex;align-items:center;justify-content:center;width:100%;height:100%}.container uni-image[data-v-14cfa353]{width:%?686?%;height:%?686?%;background-color:#f9f9f9}.canvas-box[data-v-14cfa353]{position:fixed;top:%?999999?%;left:0}.infobtnleft[data-v-14cfa353]{width:%?280?%}.infobtnright[data-v-14cfa353]{width:%?350?%}.request-form-btnline[data-v-14cfa353]{display:flex;margin-top:%?40?%;padding:0;justify-content:space-between;align-items:center}\r\n\r\n/* miniprogram/pages/optable.wxss */",""]),t.exports=e},"5ce1":function(t,e,i){"use strict";(function(t){i("7a82");var a=i("4ea4").default;Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,i("14d9"),i("99af");var n=a(i("ade3")),o=a(i("53ca")),s=i("51b3"),c=(i("460c"),null),l=getApp(),u=l.globalData,r=(u.ENCRYPTO,t.database()),f=r.collection("ProgramSet"),d=(r.collection("Users"),i("d3e5"),r.collection("Group")),v=!1,p=void 0,g=void 0,h={data:function(){return{COLORTHEMECOMMON:u.COLORTHEMECOMMON,COLORTHEME:u.COLORTHEME,COLORTHEMESTYLE:u.COLORTHEMESTYLE,THEMEID:u.THEMEID,THEMETYPE:u.THEMETYPE,THEMELIST:u.THEMELIST,VERSION:u.VERSION,AD:u.AD,HISTORY:!1,IconType:u.IconType,OpData:!1,showInfo:!1,actId:"",BookData:[],actData:!1,acttime:"",BookDatafliter:"",fliterText:"全部",operator:{name:""},time:""}},onLoad:function(t){c=this,u.RefleshGlobalData(),uni.setNavigationBarColor({backgroundColor:u.COLORTHEME["--color-main"],frontColor:u.COLORTHEME["--color-navitext"]}),this.onLoadClone3389(t)},onReady:function(){},onShow:function(){this.setData({OpData:u.USERDATA})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){this.onLoadClone3389(p,{})},onReachBottom:function(){},onShareAppMessage:function(){},methods:{onLoadClone3389:function(t){p=t,l.globalData.ServerReady(c.Reflesh)},failEndAct:function(t,e){uni.showModal({title:t,content:e.errMsg,showCancel:!1,success:function(t){}})},endAct:function(t){var e=this,i=l.globalData.getTime();console.log(t),uni.showLoading({title:"结束义诊",mask:!0}),(0,s.cbq)(d.doc(e.actId).update({ongoing:!1,end:{time:i,operator:e.OpData},lastingmin:((l.globalData.getTimeLen(i)-l.globalData.getTimeLen(e.actData.start.time))/6e4).toFixed(2),defaultPerson:t}),{success:function(i){0!=t.length?(uni.showLoading({title:"上传中",mask:!0}),(0,s.cbq)(f.doc("init").get(),{success:function(i){console.log("开始计算次数"),uni.showLoading({title:"上传中",mask:!0});var a=i.data[0],n=a.DefCount;console.log(a);var c=864e5*a.DefTimeForbidDay;"object"!=(0,o.default)(n)&&(n={});var u=a.DefTime,r=a.DefIDArr;console.log(r);for(var d=0;d<t.length;d++){var v=t[d].openid;"number"!=typeof n[v]&&(n[v]=0),n[v]=n[v]+1,"object"!=(0,o.default)(r[v])&&(r[v]=[]),r[v].push({id:t[d].bookid,date:t[d].date}),n[v]%a.DefTimeStrict==0&&(("string"!=typeof u[v]||l.globalData.getTimeLen(u[v])<(new Date).getTime())&&(u[v]=l.globalData.getTime()),u[v]=l.globalData.toTimeText(l.globalData.getTimeLen(u[v])+c))}console.log(n,u,r),(0,s.cbq)(f.doc("init").update({DefCount:n,DefTime:u,DefIDArr:r}),{success:function(t){uni.navigateBack({delta:0})},complete:function(t){uni.hideLoading({success:function(t){}})},fail:function(t){e.failEndAct("上传黑名单失败",t)}})},complete:function(t){uni.hideLoading({success:function(t){}})},fail:function(t){e.failEndAct("下载黑名单失败",t)}})):uni.navigateBack({delta:0})},complete:function(t){uni.hideLoading({success:function(t){}})},fail:function(t){e.failEndAct("上传失败",t)}})},stopAct:function(){var t=this;console.log("开始结束"),uni.showModal({title:"提示",content:"是否要结束本次义诊活动？",success:function(e){if(e.confirm){uni.showLoading({title:"统计数据",mask:!0});var i=g;t.getDb(i,0,(function(e,a){for(var o in e)if("正在义诊中"==e[o].statusText)return uni.hideLoading({success:function(t){}}),void uni.showModal({showCancel:!1,title:"结束义诊失败",content:"当前有未进行完毕的义诊预约，无法结束义诊活动"});var c=[];for(var o in console.log("DEF:",e),e)1==e[o].status&&"已统计"!==e[o].hasCal&&c.push({date:i,openid:e[o]._openid,bookid:e[o]._id,stuname:e[o].book.stuname});if(console.log(c),uni.hideLoading({success:function(t){}}),0!=c.length){var u="（"+c.length+"人）违约人：";for(var r in c)u+=c[r].stuname;uni.showModal({showCancel:!0,title:"提示",content:"是否统计违约信息？\n"+u,success:function(e){var a;e.confirm?(uni.showLoading({title:"统计数据",mask:!0}),(0,s.cbq)(v.where((a={},(0,n.default)(a,"book.date",i),(0,n.default)(a,"statusText","预约已生效"),a)).update({hasCal:"已统计",statusText:"已违约",defaultTime:l.globalData.getTime()}),{success:function(e){t.endAct(c)},complete:function(t){uni.hideLoading({success:function(t){}})},fail:function(t){uni.showModal({title:"错误",content:"统计数据失败\n"+t.errMsg,showCancel:!1})}})):e.cancel&&t.endAct([])}})}else t.endAct([])}))}}})},newAct:function(){var t=this;uni.hideLoading({success:function(t){}}),uni.showModal({title:"提示",content:"当前没有正在进行中的义诊活动，是否创建？",success:function(e){if(e.confirm){var i={_openid:u.openid,ongoing:!0,viewer:[],startperson:[],endperson:[],start:{time:l.globalData.getTime(),operator:t.OpData}};(0,s.cbq)(d.add(i),{success:function(e){uni.showToast({title:"创建成功",mask:!0}),console.log(e),t.setData({showInfo:!0,actId:e.id,actData:i})},fail:function(t){uni.showModal({title:"创建失败",content:t.errMsg,showCancel:!1,success:function(t){uni.navigateBack({delta:0})}})}})}else uni.navigateBack({delta:0});t.GetActData()}})},showQR:function(){uni.navigateTo({url:"../qr/qr?tip=义诊活动 - 部长二维码 - "+this.OpData.name+"&text=group"+this.actId})},Reflesh:function(){var t=u.AppSet;("number"!=typeof u.USERDATA.powerid||u.USERDATA.powerid<2)&&uni.showModal({title:"进入工作台失败",content:"您无权访问该页面",showCancel:!1,success:function(t){t.confirm&&uni.navigateBack()}}),uni.showLoading({title:"加载中",mask:!0});var e,i=this;this.setData({showInfo:!1,actData:!1}),console.log(p),p&&p.ACTID?(e={_id:p.ACTID},uni.setNavigationBarTitle({title:"义诊活动历史记录"}),this.setData({HISTORY:!0})):e={ongoing:!0},(0,s.cbq)(d.where(e).get(),{success:function(t){var e=t.data;if(0==e.length)i.newAct();else{e=e[0],i.setData({showInfo:!0,actId:e._id,actData:e});r.command;uni.stopPullDownRefresh({success:function(t){}}),uni.hideLoading({success:function(t){}}),i.GetActData(e.start.time.split(" ")[0])}},fail:function(t){uni.showModal({title:"错误",content:t.errMsg,showCancel:!1,success:function(t){uni.navigateBack({delta:0})}})}}),console.log(t),v=r.collection(t.ColName2)},GetActData:function(t){"undefined"==typeof t&&(t=l.globalData.getTime(!0,!1)),console.log(p),p&&p.ACTID&&(t=p.TIME),g=t,this.setData({acttime:t}),this.getDb(t,0)},DataFliter:function(t){var e=t.currentTarget.dataset.id;if(console.log(e),"全部"==e)this.setData({BookDatafliter:this.BookData,fliterText:e});else{var i=this.BookData;this.BookDatafliter=[];for(var a=0;a<i.length;a++){if("未到"==e){if("预约已生效"!=i[a].statusText)continue}else if("取消"==e){if("预约已取消"!=i[a].statusText)continue}else if("进行中"==e){if("正在义诊中"!=i[a].statusText)continue}else if("完成"==e){if("义诊已完成，待评价"!=i[a].statusText&&"义诊已完成"!=i[a].statusText)continue}else if("其他"==e){if("预约已生效"==i[a].statusText)continue;if("预约已取消"==i[a].statusText)continue;if("正在义诊中"==i[a].statusText)continue;if("义诊已完成，待评价"==i[a].statusText||"义诊已完成"==i[a].statusText)continue}this.BookDatafliter.push(i[a])}this.setData({BookDatafliter:this.BookDatafliter,fliterText:e})}},BookDetail:function(t){uni.navigateTo({url:"../bookinfo/bookinfo?id="+t.currentTarget.dataset.id+"&op=true&reop=true"})},getDb:function(t,e,i){0==e&&(this.BookData=[]);var a=this,o=r.command;(0,s.cbq)(v.where(o.or([(0,n.default)({},"date",t),(0,n.default)({},"book.date",t)])).orderBy("book.uploadtime","asc").skip(20*e).limit(20).get(),{success:function(s){console.log(s);var c=l.globalData.dealOldVerBook(s.data);a.setData({BookData:a.BookData.concat(c)}),a.setData({BookDatafliter:a.BookData}),console.log(a.BookData),20==c.length?(console.log("ddddd:",e),a.getDb(t,e+1,i)):(console.log("aaaaa:",e),"function"==typeof i&&i(a.BookData,o.or([(0,n.default)({},"date",t),(0,n.default)({},"book.date",t)])))},fail:l.globalData.showFail})}}};e.default=h}).call(this,i("a9ff")["default"])},"66da":function(t,e,i){"use strict";i.r(e);var a=i("732f"),n=i("04c2");for(var o in n)["default"].indexOf(o)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(o);i("14c6");var s=i("f0c5"),c=i("4e14"),l=Object(s["a"])(n["default"],a["b"],a["c"],!1,null,"14cfa353",null,!1,a["a"],void 0);"function"===typeof c["a"]&&Object(c["a"])(l),e["default"]=l.exports},"732f":function(t,e,i){"use strict";i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return n})),i.d(e,"a",(function(){}));var a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-uni-view",{style:t.COLORTHEMECOMMON},[i("v-uni-view",{staticClass:"pagecontent",staticStyle:{"justify-content":"flex-start"},style:t.COLORTHEMESTYLE},[i("v-uni-view",{staticClass:"PAGECONTENT con"},[t.showInfo?i("v-uni-view",{staticClass:"FORM"},[t.HISTORY?t._e():[i("v-uni-view",{staticClass:"FORMheadline"},[i("v-uni-view",{staticStyle:{"font-size":"60rpx","font-weight":"700"}},[t._v("欢迎您，"+t._s(t.OpData.name))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline",staticStyle:{padding:"0",margin:"15rpx 0 0 0"}},[i("v-uni-button",{staticClass:"infobtnleft",attrs:{normal:!0},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.stopAct.apply(void 0,arguments)}}},[t._v("结束义诊")]),i("v-uni-button",{staticClass:"infobtnright",on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.showQR.apply(void 0,arguments)}}},[t._v("展示部长二维码")])],1)],t.HISTORY?i("v-uni-view",{staticClass:"FORMheadline"},[i("v-uni-view",{staticStyle:{"font-size":"60rpx","font-weight":"700"}},[t._v("义诊历史记录")])],1):t._e(),i("v-uni-view",{staticStyle:{height:"30rpx"}}),i("v-uni-view",{staticClass:"FORMtextline",staticStyle:{margin:"40rpx 0 0 10rpx"}},[t._v("义诊活动信息")]),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("活动ID")]),i("v-uni-view",{staticClass:"FORMlineright",staticStyle:{"word-break":"normal"}},[t._v(t._s(t.actId))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("创建人")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.actData.start.operator.name))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("开始时间")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.actData.start.time))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("签到")]),i("v-uni-view",{staticClass:"FORMlineright"},[i("v-uni-view",{staticClass:"FORMitem"},t._l(t.actData.startperson,(function(e,a){return i("v-uni-view",{key:a,staticClass:"FORMitem FORMline"},[t._v(t._s(t.m.s(e.time))+" / "+t._s(e.operator.name))])})),1)],1)],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("签退")]),i("v-uni-view",{staticClass:"FORMlineright"},[i("v-uni-view",{staticClass:"FORMitem"},t._l(t.actData.endperson,(function(e,a){return i("v-uni-view",{key:a,staticClass:"FORMitem FORMline"},[t._v(t._s(t.m.s(e.time))+" / "+t._s(e.operator.name))])})),1)],1)],1),t.HISTORY?[i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("结束时间")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.actData.end.time))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("结束人")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.actData.end.operator.name))])],1)]:t._e(),i("v-uni-view",{staticStyle:{height:"30rpx"}}),i("v-uni-view",{staticClass:"FORMtextline",staticStyle:{margin:"20rpx 0 0 10rpx"}},[t._v("当日预约信息 ("+t._s(t.acttime)+")")]),i("v-uni-view",{staticClass:"LineFliterLine"},[i("v-uni-view",{staticClass:"LineFliterHead",staticStyle:{"font-size":"18rpx"}},[t._v("状态筛选")]),t._l(["全部","未到","进行中","完成","取消","其他"],(function(e,a){return i("v-uni-view",{class:t.fliterText==e?"LineFliterActive":"LineFliter",staticStyle:{"font-size":"18rpx"},attrs:{"data-id":e},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.DataFliter.apply(void 0,arguments)}}},[t._v(t._s(e))])}))],2),0==t.BookDatafliter.length?i("v-uni-view",{staticClass:"FORMitem FORMline"},[t._v("暂无此状态预约")]):t._e(),t._l(t.BookDatafliter,(function(e,a){return i("v-uni-view",{key:a,staticClass:"FORMitem"},[i("v-uni-view",{staticClass:"FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("["+t._s(a+1)+"]"),i("v-uni-icon",{staticClass:"icon-small ICONs",attrs:{color:"var(--color-main)",type:t.IconType[e.statusText]?t.IconType[e.statusText]:"success",size:"50rpx"}}),t._v(t._s(e.statusText))],1),i("v-uni-view",{staticClass:"FORMlineright",staticStyle:{"font-size":"20rpx"}},[t._v(t._s(e.book.date+(-1==e.book.section?" 临时预约":" 第"+e.book.section+"时段")))])],1),i("v-uni-view",{staticClass:"FORMline",staticStyle:{"white-space":"pre-wrap"},attrs:{"data-id":e._id},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.BookDetail.apply(void 0,arguments)}}},[t._v(t._s("学工号："+e.book.stuid+"\n姓名："+e.book.stuname+"\n手机号："+e.book.mobile+"\n问题概述："+e.book.question)),"预约已生效"!=e.statusText&&"已违约"!=e.statusText&&"预约已取消"!=e.statusText?[t._v(t._s("\n处理人："+e.resolve.name))]:t._e(),"义诊已完成"==e.statusText?[t._v(t._s("\n评分："+e.comment.star)+"星")]:t._e()],2)],1)}))],2):t._e()],1)],1)],1)},n=[]},d3e5:function(t,e,i){"use strict";i("7a82"),Object.defineProperty(e,"__esModule",{value:!0}),e.ca=void 0,e.request=l,e.showFail=c;i("51b3"),i("460c");var a=getApp(),n=a.globalData,o=n.ENCRYPTO,s="加载";function c(t,e){"string"!=typeof e&&(e=s),uni.hideLoading(),uni.showModal({title:e+"失败",content:t,showCancel:!1})}function l(t){var e,i,a,l,u=t.title,r=t.tipShow,f=t.tipOption,d=t.tipActionCancel,v=t.tipActionSuccess,p=(t.packPublicKey,t.data),g=t.keyOption,h=t.optionUrl,w=t.urlPath,O=t.success,m=t.fail;if("boolean"!=typeof r&&(r=!0),"string"!=typeof u&&(u="加载"),s=u,console.log("开始请求",u,t),r){if(!f)return void console.error("使用tipShow请传入tipOption");if(e=f.WAIT,i=f.tipText,a=f.tipSubText,l=f.cancelText,!e)return void console.error("使用tipShow请传入tipOption.WAIT，请使用当前显示页面的WAITObj！");i||(i="正在"+u),a||(a="请稍后"),l||(l="取消")}var D={};r&&n.showWait(e,i,a,l,(function(t,e){if(t){if("function"==typeof v&&v(e))return;e()}else{if("function"==typeof D.abort&&D.abort(),"function"==typeof d&&d(e))return;e()}})),console.log("keyoption=",g);var M=o.cover.packData(p,!0,g),T="http://"+n.ServerUrl+"/"+n.AppServerName+"/"+w;console.log(w),h&&(T=w),console.log(T),D=uni.request({url:T,method:"POST",header:{"content-type":"application/json"},data:M,responseType:"json",sslVerify:!1,firstIpv4:!0,success:function(t){if(console.log("收到数据",t),200!=t.statusCode)return r&&n.hideWait(e,!1),void c("服务器错误："+t.data.error,u);var i=o.cover.unpackData(t.data),a=function(t){"boolean"!=typeof t&&(t=!0),r&&n.hideWait(e,t)};"function"==typeof O&&O(i,a)||a()},fail:function(t){console.log("请求失败",t);var i=function(){(r||"function"!=typeof m)&&c("错误："+t.errMsg,u),r&&n.hideWait(e,!1)};"function"==typeof m&&(r&&c("错误："+t.errMsg,u),m(t,i))||i()}})}var u=i("ffcd"),r=i("1818"),f={getPublicKey:u.ca.getPublicKey,getPublicSignKey:u.ca.getPublicSignKey,querySignValid:function(t,e,i){return uni.showLoading({title:"签名验证中"}),r.verifySign(t,e,this.getPublicSignKey())?(console.log(n.CAURL),l({tipShow:!1,title:"验证签名",optionUrl:!0,urlPath:n.CAURL+"queryB",keyOption:this.getPublicKey(),data:{certificate:e},success:function(e,a){if(uni.hideLoading(),e.status){if(1==e.data){var n=JSON.parse(t).data;i(n)}else i("");a(!0)}else a(!1),server.showFail(e.errMsg);return!0},fail:function(){uni.hideLoading(),i("")}}),!0):(uni.hideLoading(),!1)}};e.ca=f},de2d:function(t,e,i){var a=i("579c");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var n=i("4f06").default;n("72eecc86",a,!0,{sourceMap:!1,shadowMode:!1})}}]);