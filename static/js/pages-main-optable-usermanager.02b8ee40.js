(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-main-optable-usermanager"],{1261:function(t,e,i){"use strict";(function(t){i("7a82");var n=i("4ea4").default;Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=n(i("53ca"));i("4e82"),i("e9c4"),i("b64b"),i("14d9"),i("d401"),i("d3b7"),i("25f0"),i("ac1f"),i("5319");var o=i("51b3"),r=i("460c"),s=null,c=getApp(),l=c.globalData,u=(l.ENCRYPTO,t.database()),d=(u.collection("ProgramSet"),u.collection("Users")),f=(i("d3e5"),u.collection("Group"),{data:function(){return{m:{s:function(t){return t.split(" ")[1]}},COLORTHEMECOMMON:l.COLORTHEMECOMMON,COLORTHEME:l.COLORTHEME,COLORTHEMESTYLE:l.COLORTHEMESTYLE,THEMEID:l.THEMEID,THEMETYPE:l.THEMETYPE,THEMELIST:l.THEMELIST,VERSION:l.VERSION,AD:l.AD,IconType:l.IconType,OpData:!1,showInfo:!1,actId:"",userDataStatus:{total:0,totalreg:0,totalunreg:0,totalpower:{},totalpowerarr:[],totalpowerid:{},totalpoweridarr:[]},UserDatafliter:"",fliterText:"社员",FliterRange:["非社员","社员","管理员","申请加入","旧版"],SortTargetRange:["默认排序","姓名","学号","权限等级"],SortTarget:["uid","name","stuid","powerid"],SortTarget2:["name","stuid","name","power"],SortMethodRange:["升序","降序"],SortPickerId:"默认排序 降序",userorigindata:[],operator:{name:""},time:""}},onLoad:function(t){s=this,l.RefleshGlobalData(),uni.setNavigationBarColor({backgroundColor:l.COLORTHEME["--color-main"],frontColor:l.COLORTHEME["--color-navitext"]}),this.onLoadClone3389(t)},onReady:function(){},onShow:function(){this.setData({OpData:l.USERDATA})},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){this.onLoadClone3389(void 0,{})},onReachBottom:function(){},onShareAppMessage:function(){},methods:{onLoadClone3389:function(t){l.ServerReady(s.Reflesh)},failEndAct:function(t,e){uni.showModal({title:t,content:e.errMsg,showCancel:!1,success:function(t){}})},showQR:function(){uni.navigateTo({url:"../qr/qr?tip=义诊活动 - 部长二维码 - "+this.OpData.name+"&text=group"+this.actId})},Reflesh:function(){var t=l.AppSet;if("number"!=typeof l.USERDATA.powerid||l.USERDATA.powerid<2)uni.showModal({title:"进入社员管理失败",content:"您无权访问该页面",showCancel:!1,success:function(t){t.confirm&&uni.navigateBack()}});else{uni.showLoading({title:"加载中",mask:!0}),this.setData({showInfo:!1,userDataStatus:!1}),u.collection(t.ColName2);var e=u.command,i=e.aggregate;(0,o.cbq)(d.aggregate().group({_id:"null",arr:i.addToSet({_id:"$_id",_openid:"$_openid",account:"$account",name:"$name",uid:"$uid",stuid:"$stuid",power:"$power",powerid:"$powerid",requestJoinIn:"$requestJoinIn",requestJoinInData:"$requestJoinInData",grade:"$grade",stutype:"$stutype",gender:"$gender",school:"$school",major:"$major",mobile:"$mobile",qq:"$qq",cpcMemberName:"$cpcMemberName",cpcMemberRequest:"$cpcMemberRequest"})}).end(),{success:function(t){var e=r.sort(t.data[0].arr,"_id");for(var i in e)e[i].oindex=i;s.setData({userorigindata:e}),uni.stopPullDownRefresh({success:function(t){}}),uni.hideLoading({success:function(t){}}),console.log("USERS",JSON.parse(JSON.stringify(e))),s.GetUserData(e)},fail:function(t){uni.showModal({title:"错误",content:t.errMsg,showCancel:!1,success:function(t){uni.navigateBack({delta:0})}})}})}},GetUserData:function(){var t=s.userorigindata,e={total:0,totalreg:0,totalunreg:0,totalpower:{},totalpowerarr:[],totalpowerid:{},totalpoweridarr:[]};e.total=t.length;var i=0;for(var n in t)"string"==typeof t[n].account&&(i++,"undefined"!=typeof t[n].power&&("undefined"==typeof e.totalpower[t[n].power]?e.totalpower[t[n].power]=1:e.totalpower[t[n].power]+=1),"undefined"!=typeof t[n].powerid&&("undefined"==typeof e.totalpowerid[t[n].powerid]?e.totalpowerid[t[n].powerid]=1:e.totalpowerid[t[n].powerid]+=1));e.totalreg=i,e.totalunreg=t.length-i,e.totalpoweridarr=Object.keys(e.totalpowerid),e.totalpowerarr=Object.keys(e.totalpower),console.log(e),s.setData({userDataStatus:e,showInfo:!0}),s.DataFliter({currentTarget:{dataset:{id:s.fliterText}}})},DataFliter:function(t){var e=t.currentTarget.dataset.id;console.log(e);var i=this.userorigindata;this.UserDatafliter=[];for(var n=0;n<i.length;n++){if("非社员"==e){if("string"!=typeof i[n].account)continue;if(i[n].powerid>=1)continue}else if("管理员"==e){if("string"!=typeof i[n].account)continue;if(i[n].powerid<=1)continue}else if("申请加入"==e){if("string"!=typeof i[n].account)continue;if(1!=i[n].requestJoinIn)continue}else if("社员"==e){if("string"!=typeof i[n].account)continue;if(i[n].powerid<1)continue}else if("旧版"==e&&"string"==typeof i[n].account)continue;this.UserDatafliter.push(i[n])}this.setData({UserDatafliter:this.UserDatafliter,fliterText:e})},sortData:function(t){var e=t.detail.value,i=s.SortMethodRange[e[1]],n=s.SortTargetRange[e[0]];s.setData({SortPickerId:n+" "+i});var a=s.SortTarget[e[0]],o=s.SortTarget2[e[0]],c=1==e[0],l=r.sort(s.userorigindata,a,c,!1,o);for(var u in l)l[u].oindex=u;s.userorigindata=l,s.DataFliter({currentTarget:{dataset:{id:s.fliterText}}})},UserDetail:function(t){uni.showModal({title:"用户详细信息："+t.name+"("+t.stuid+")",content:"姓名："+t.name+"\n学号："+t.stuid+"\n权限等级："+t.powerid+"\n权限标签："+t.power+"\n微信状态："+(t.uid==t._openid?"未绑定":"已绑定\n微信OPENID："+t._openid)+"\nUID："+t.uid+(t.powerid<1&&!t.requestJoinIn?"":"\n加入社团时的请求信息："+JSON.stringify(t.requestJoinInData)+"\n年级："+t.grade+"\n学历："+t.stutype+"\n性别："+t.gender+"\n学院："+t.school+"\n专业："+t.major+"\n手机："+t.mobile+"\nQQ号："+t.qq+"\n政治面貌："+t.cpcMemberName+"\n是否是入党积极分子："+t.cpcMemberRequest),showCancel:!1})},getUserNextLevel:function(t,e){var i=["普通用户","社员","社团部长","主席团成员"],n=t.powerid,a=t.powerid+e;return n>i.length-1&&(n=i.length-1),n<0&&(n=0),a>i.length-1&&(a=i.length-1),a<0&&(a=0),t.power==i[n]?i[a]:t.power},setUser:function(e,i,n){var a,c=function(e,i,n,a,s,c){u.command;var l={doc:i._id,data:a,logobj:c};(0,o.cbq)(t.callFunction({name:"updateUserWithLog",data:l}),{success:function(t){console.log("更新结果",t),uni.hideLoading(),t.updated?(uni.showToast({title:"设置成功"}),s()):r.showFail("内部错误","设置")},fail:function(t){uni.hideLoading(),r.showFail(t,"设置")}})},d={setLabal:function(t,e,i,n,a,o){var r=e.oindex;c(0,e,0,{power:n},(function(){s.userorigindata[r].power=n,s.UserDatafliter[t].power=n}),o)},UpOrDeGrade:function(t,e,i,n,a,o){var r=e.oindex,l={powerid:n};"string"==typeof a&&(l.power=a),n>0&&(l.requestJoinIn=!1),c(0,e,0,l,(function(){s.userorigindata[r].powerid=n,s.userorigindata[r].power=a,s.UserDatafliter[t].powerid=n,s.UserDatafliter[t].power=a,n>0&&(s.UserDatafliter[t].requestJoinIn=!1,s.userorigindata[r].requestJoinIn=!1)}),o)}},f="设置标签名称",p=i.power,v=d.setLabal,w="",g={uid:l.USERDATA.uid,name:l.USERDATA.name,stuid:l.USERDATA.stuid,text:""};if(1==n){if(f="提升权限",v=d.UpOrDeGrade,w=i.powerid+1,p="权限变化："+i.powerid+"->"+w,a=s.getUserNextLevel(i,n),"string"==typeof a&&(p+="\n标签变化："+i.power+"->"+a),w>=3&&l.USERDATA.powerid<3||i.powerid>l.USERDATA.powerid)return void uni.showModal({title:"提示",showCancel:!1,content:"您没有权限对该等级用户进行此操作"})}else if(-1==n&&(f="降低权限",v=d.UpOrDeGrade,w=i.powerid-1,p="权限变化："+i.powerid+"->"+w,a=s.getUserNextLevel(i,n),"string"==typeof a&&(p+="\n标签变化："+i.power+"->"+a),i.powerid>l.USERDATA.powerid))return void uni.showModal({title:"提示",showCancel:!1,content:"您没有权限对该等级用户进行此操作"});uni.showModal({title:f+"："+i.name+"("+i.stuid+")",editable:0==n,content:p,success:function(t){t.confirm&&(0==n&&(w=t.content),g=f+"："+p+"("+w+")",uni.showLoading({title:"加载中",mask:!0}),v(e,i,n,w,a,g))},fail:function(t){r.showFail(t,"设置")}})},genUserData:function(){var t=s.userorigindata,e="_openid,uid,account,stuid,name,power,powerid,requestJoinIn,requestJoinInData,log,grade,stutype,gender,school,major,mobile,qq,cpcMemberName,cpcMemberRequest",i=e.split(","),n=e+"\n";for(var o in t)if("string"==typeof t[o].account){for(var r in i){var c=(0,a.default)(t[o][i[r]]);try{n+="string"==c||"number"==c||"boolean"==c?'"'+t[o][i[r]].toString()+'",':"object"==c?'"'+JSON.stringify(t[o][i[r]]).replace(/\"/g,'""')+'",':","}catch(l){n+="导出错误,"}}n+="\n"}return n},ExportUser:function(){uni.showModal({title:"导出全部用户",content:'将导出用户为CSV格式到剪切板，需要自行创建CSV文件然后粘贴，如使用Excel打开后出现编码错误，请在粘贴到txt后保存为"带有 BOM 的 UTF-8"格式',success:function(t){t.confirm&&uni.setClipboardData({data:s.genUserData(),success:function(){uni.showToast({title:"复制成功"})}})}})}}});e.default=f}).call(this,i("a9ff")["default"])},"476c":function(t,e,i){var n=i("24fb");e=n(!1),e.push([t.i,".FORMlineright[data-v-f32a20bc]{max-width:%?525?%;overflow:scroll}.FORMtextline[data-v-f32a20bc],\n.FORMheadline[data-v-f32a20bc]{font-weight:800}.FORMtextline[data-v-f32a20bc]{font-size:%?35?%}uni-view[data-v-f32a20bc],\nuni-text[data-v-f32a20bc]{-webkit-user-select:text;user-select:text}.container[data-v-f32a20bc]{display:flex;align-items:center;justify-content:center;width:100%;height:100%}.container uni-image[data-v-f32a20bc]{width:%?686?%;height:%?686?%;background-color:#f9f9f9}.canvas-box[data-v-f32a20bc]{position:fixed;top:%?999999?%;left:0}.infobtnleft[data-v-f32a20bc]{width:%?280?%}.infobtnright[data-v-f32a20bc]{width:%?350?%}.request-form-btnline[data-v-f32a20bc]{display:flex;margin-top:%?40?%;padding:0;justify-content:space-between;align-items:center}\n\n/* miniprogram/pages/optable.wxss */",""]),t.exports=e},"4a6f":function(t,e,i){"use strict";var n=i("c258"),a=i.n(n);a.a},"65c5":function(t,e,i){"use strict";i.r(e);var n=i("1261"),a=i.n(n);for(var o in n)["default"].indexOf(o)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(o);e["default"]=a.a},"81ed":function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"c",(function(){return a})),i.d(e,"a",(function(){}));var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-uni-view",{style:t.COLORTHEMECOMMON},[i("v-uni-view",{staticClass:"pagecontent",staticStyle:{"justify-content":"flex-start"},style:t.COLORTHEMESTYLE},[i("v-uni-view",{staticClass:"PAGECONTENT con"},[t.showInfo?i("v-uni-view",{staticClass:"FORM"},[[i("v-uni-view",{staticClass:"FORMheadline"},[i("v-uni-view",{staticStyle:{"font-size":"60rpx","font-weight":"700"}},[t._v("欢迎您，"+t._s(t.OpData.name))])],1)],i("v-uni-view",{staticStyle:{height:"30rpx"}}),i("v-uni-view",{staticClass:"FORMtextline",staticStyle:{margin:"40rpx 0 0 10rpx"}},[t._v("注册账户信息统计")]),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("总用户数")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.userDataStatus.total))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("注册用户数")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.userDataStatus.totalreg))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("旧版未注册用户数")]),i("v-uni-view",{staticClass:"FORMlineright"},[t._v(t._s(t.userDataStatus.totalunreg))])],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("职务分级用户数")]),i("v-uni-view",{staticClass:"FORMlineright"},[i("v-uni-view",{staticClass:"FORMitem"},t._l(t.userDataStatus.totalpowerarr,(function(e,n){return i("v-uni-view",{key:n,staticClass:"FORMitem FORMline"},[t._v(t._s(e)+"："+t._s(t.userDataStatus.totalpower[e]))])})),1)],1)],1),i("v-uni-view",{staticClass:"FORMitem FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("权限分级用户数")]),i("v-uni-view",{staticClass:"FORMlineright"},[i("v-uni-view",{staticClass:"FORMitem"},t._l(t.userDataStatus.totalpoweridarr,(function(e,n){return i("v-uni-view",{key:n,staticClass:"FORMitem FORMline"},[t._v(t._s(e)+"级："+t._s(t.userDataStatus.totalpowerid[e]))])})),1)],1)],1),i("v-uni-view",{staticStyle:{height:"30rpx"}}),i("v-uni-view",{staticClass:"FORMline",staticStyle:{margin:"20rpx 0 0 10rpx"}},[i("v-uni-view",{staticStyle:{display:"flex","align-items":"center"}},[i("v-uni-view",{staticClass:"FORMtextline"},[t._v("用户管理")]),i("v-uni-view",{staticClass:"LineFliterActive",staticStyle:{"margin-left":"20rpx"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.ExportUser()}}},[t._v("导出")])],1),i("v-uni-view",[i("v-uni-picker",{staticClass:"MODELpicker",attrs:{range:[t.SortTargetRange,t.SortMethodRange],mode:"multiSelector"},on:{change:function(e){arguments[0]=e=t.$handleEvent(e),t.sortData(e)}}},[t._v(t._s(t.SortPickerId))])],1)],1),i("v-uni-view",{staticClass:"LineFliterLine"},[i("v-uni-view",{staticClass:"LineFliterHead",staticStyle:{"font-size":"22rpx"}},[t._v("筛选")]),t._l(t.FliterRange,(function(e,n){return i("v-uni-view",{class:t.fliterText==e?"LineFliterActive":"LineFliter",staticStyle:{"font-size":"22rpx"},attrs:{"data-id":e},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.DataFliter.apply(void 0,arguments)}}},[t._v(t._s(e))])}))],2),0==t.UserDatafliter.length?i("v-uni-view",{staticClass:"FORMitem FORMline"},[t._v("暂无此分类用户")]):t._e(),t._l(t.UserDatafliter,(function(e,n){return i("v-uni-view",{key:n,staticClass:"FORMitem"},["旧版"==t.fliterText?i("v-uni-view",{staticClass:"FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft"},[t._v("["+t._s(e.uid)+"]"+t._s(e._openid))])],1):t._e(),"旧版"!=t.fliterText?i("v-uni-view",{staticClass:"FORMline"},[i("v-uni-view",{staticClass:"FORMlineleft",staticStyle:{display:"flex","flex-direction":"column","text-align":"left"}},[i("v-uni-text",[t._v("["+t._s(e.uid)+"] "+t._s(e.name)+" ("+t._s(e.stuid)+")")]),i("v-uni-text",[e.uid!=e._openid?i("v-uni-text",{staticClass:"iconfont icon-weixin"}):t._e(),t._v(t._s(e.power)+"("+t._s(e.powerid)+")")],1)],1),i("v-uni-view",{staticClass:"FORMlineright"},[i("v-uni-view",{staticClass:"LineFliterActive iconfont icon-tishi",on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.UserDetail(e)}}}),i("v-uni-view",{staticClass:"LineFliterActive iconfont icon-pingtaifuwu",on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.setUser(n,e,0)}}}),i("v-uni-view",{staticClass:"LineFliterActive iconfont icon-shangyi",on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.setUser(n,e,1)}}}),i("v-uni-view",{staticClass:"LineFliterActive iconfont icon-xiayi",on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.setUser(n,e,-1)}}})],1)],1):t._e()],1)}))],2):t._e()],1)],1)],1)},a=[]},c258:function(t,e,i){var n=i("476c");n.__esModule&&(n=n.default),"string"===typeof n&&(n=[[t.i,n,""]]),n.locals&&(t.exports=n.locals);var a=i("4f06").default;a("11e45a2b",n,!0,{sourceMap:!1,shadowMode:!1})},d259:function(t,e,i){"use strict";i.r(e);var n=i("81ed"),a=i("65c5");for(var o in a)["default"].indexOf(o)<0&&function(t){i.d(e,t,(function(){return a[t]}))}(o);i("4a6f");var r=i("f0c5"),s=Object(r["a"])(a["default"],n["b"],n["c"],!1,null,"f32a20bc",null,!1,n["a"],void 0);e["default"]=s.exports},d3e5:function(t,e,i){"use strict";i("7a82"),Object.defineProperty(e,"__esModule",{value:!0}),e.ca=void 0,e.request=c,e.showFail=s;i("51b3"),i("460c");var n=getApp(),a=n.globalData,o=a.ENCRYPTO,r="加载";function s(t,e){"string"!=typeof e&&(e=r),uni.hideLoading(),uni.showModal({title:e+"失败",content:t,showCancel:!1})}function c(t){var e,i,n,c,l=t.title,u=t.tipShow,d=t.tipOption,f=t.tipActionCancel,p=t.tipActionSuccess,v=(t.packPublicKey,t.data),w=t.keyOption,g=t.optionUrl,h=t.urlPath,O=t.success,M=t.fail;if("boolean"!=typeof u&&(u=!0),"string"!=typeof l&&(l="加载"),r=l,console.log("开始请求",l,t),u){if(!d)return void console.error("使用tipShow请传入tipOption");if(e=d.WAIT,i=d.tipText,n=d.tipSubText,c=d.cancelText,!e)return void console.error("使用tipShow请传入tipOption.WAIT，请使用当前显示页面的WAITObj！");i||(i="正在"+l),n||(n="请稍后"),c||(c="取消")}var R={};u&&a.showWait(e,i,n,c,(function(t,e){if(t){if("function"==typeof p&&p(e))return;e()}else{if("function"==typeof R.abort&&R.abort(),"function"==typeof f&&f(e))return;e()}})),console.log("keyoption=",w);var m=o.cover.packData(v,!0,w),y="http://"+a.ServerUrl+"/"+a.AppServerName+"/"+h;console.log(h),g&&(y=h),console.log(y),R=uni.request({url:y,method:"POST",header:{"content-type":"application/json"},data:m,responseType:"json",sslVerify:!1,firstIpv4:!0,success:function(t){if(console.log("收到数据",t),200!=t.statusCode)return u&&a.hideWait(e,!1),void s("服务器错误："+t.data.error,l);var i=o.cover.unpackData(t.data),n=function(t){"boolean"!=typeof t&&(t=!0),u&&a.hideWait(e,t)};"function"==typeof O&&O(i,n)||n()},fail:function(t){console.log("请求失败",t);var i=function(){(u||"function"!=typeof M)&&s("错误："+t.errMsg,l),u&&a.hideWait(e,!1)};"function"==typeof M&&(u&&s("错误："+t.errMsg,l),M(t,i))||i()}})}var l=i("ffcd"),u=i("1818"),d={getPublicKey:l.ca.getPublicKey,getPublicSignKey:l.ca.getPublicSignKey,querySignValid:function(t,e,i){return uni.showLoading({title:"签名验证中"}),u.verifySign(t,e,this.getPublicSignKey())?(console.log(a.CAURL),c({tipShow:!1,title:"验证签名",optionUrl:!0,urlPath:a.CAURL+"queryB",keyOption:this.getPublicKey(),data:{certificate:e},success:function(e,n){if(uni.hideLoading(),e.status){if(1==e.data){var a=JSON.parse(t).data;i(a)}else i("");n(!0)}else n(!1),server.showFail(e.errMsg);return!0},fail:function(){uni.hideLoading(),i("")}}),!0):(uni.hideLoading(),!1)}};e.ca=d}}]);